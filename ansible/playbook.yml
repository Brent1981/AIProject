# Ansible Playbook for Setting Up the AI Powerhouse Server
# This playbook automates the complete setup of the AI server.

- name: Provision AI Powerhouse Server
  hosts: ai_powerhouse
  become: true # This tells Ansible to run tasks with root privileges (using sudo)

  tasks:
    - name: Update apt package cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600 # One hour
      tags: ['packages']

    - name: Install common system packages
      ansible.builtin.apt:
        name:
          - git
          - vim
          - curl
          - wget
          - htop
        state: present
      tags: ['packages']

    - name: Install NFS client tools
      ansible.builtin.apt:
        name: nfs-common
        state: present
      tags: ['packages', 'nfs']

    # --- Docker Installation ---
    - name: Install prerequisites for Docker repository
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Create directory for apt keyrings
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker's official GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
        force: true

    - name: Add Docker's repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Install Docker Engine and plugins
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Ensure Docker service is started and enabled
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Add user to the docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      tags: ['docker', 'users']

    # --- NVIDIA Driver & Container Toolkit Installation ---
    # NOTE: NVIDIA driver installation can be sensitive. These tasks are based on
    # standard procedures for Ubuntu and may need adjustment.
    - name: Add NVIDIA's GPG key
      ansible.builtin.get_url:
        url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/3bf863cc.pub
        dest: /etc/apt/keyrings/nvidia-cuda.asc
        mode: '0644'
        force: true
      tags: ['nvidia', 'docker']

    - name: Add NVIDIA's repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/nvidia-cuda.asc] https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/ /"
        state: present
        filename: nvidia-cuda
      tags: ['nvidia', 'docker']

    - name: Install NVIDIA driver and toolkit
      ansible.builtin.apt:
        name:
          - cuda-drivers
          - nvidia-container-toolkit
        state: present
        update_cache: yes
      tags: ['nvidia', 'docker']

    - name: Configure Docker to use the NVIDIA runtime
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "runtimes": {
              "nvidia": {
                "path": "/usr/bin/nvidia-container-runtime",
                "runtimeArgs": []
              }
            },
            "default-runtime": "nvidia"
          }
        owner: root
        group: root
        mode: '0644'
      notify: Restart Docker
      tags: ['nvidia', 'docker']

  handlers:
    - name: Restart Docker
      ansible.builtin.service:
        name: docker
        state: restarted

    #
    # --- Application Code Checkout ---
    #
    - name: Clone the aiproject repository
      ansible.builtin.git:
        repo: https://github.com/Brent1981/AIProject.git
        dest: /home/{{ ansible_user }}/aiproject
        version: main
        force: yes
      become_user: "{{ ansible_user }}"
      tags: ['app']

    #
    # --- Environment Configuration ---
    #
    - name: Copy environment file from template
      ansible.builtin.template:
        src: ../.env.template # Assumes you run ansible from the project root
        dest: /home/{{ ansible_user }}/aiproject/.env
      become_user: "{{ ansible_user }}"
      tags: ['app', 'config']

    #
    # --- Deploy Application Stack ---
    #
    - name: Start the AI Powerhouse Docker stack
      ansible.builtin.command:
        cmd: /home/{{ ansible_user }}/aiproject/ai_powerhouse/scripts/start.sh
      args:
        chdir: /home/{{ ansible_user }}/aiproject/ai_powerhouse/scripts/
      become_user: "{{ ansible_user }}"
      tags: ['app', 'deploy']
