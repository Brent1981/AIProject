# /etc/nginx/sites-available/hogwarts-castle.conf
#
# This is an example configuration for your Hogwarts Castle dashboard.
# You will need to:
# 1. Move this file to your Nginx configuration directory (e.g., /etc/nginx/sites-available/).
# 2. Create a symbolic link to it in the sites-enabled directory.
#    sudo ln -s /etc/nginx/sites-available/hogwarts-castle.conf /etc/nginx/sites-enabled/
# 3. Edit the placeholder IP addresses and ports to match your services.
# 4. Ensure you have a valid SSL certificate (e.g., from Let's Encrypt).
# 5. Test the configuration with `sudo nginx -t` and then reload Nginx.

# Redirect all HTTP traffic to HTTPS
server {
    listen 80;
    server_name www.hogwarts-castle.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name www.hogwarts-castle.com;

    # --- SSL Configuration ---
    # IMPORTANT: Replace these paths with the actual paths to your SSL certificate and key.
    # These are the default paths for certificates obtained with Certbot.
    ssl_certificate /etc/letsencrypt/live/www.hogwarts-castle.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.hogwarts-castle.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # --- Web Root for the Dashboard ---
    # This is the directory where you should place the `index.html` file.
    # For example: /var/www/hogwarts-castle
    root /var/www/hogwarts-castle;
    index index.html;

    # --- Main Dashboard Location ---
    location / {
        try_files $uri $uri/ =404;
    }

    # --- Reverse Proxy Configurations ---
    # For each service, we create a `location` block that proxies requests
    # to the internal IP address and port of that service.

    # --- Home Assistant ---
    # Accessible at https://www.hogwarts-castle.com/homeassistant/
    location /homeassistant/ {
        # IMPORTANT: Replace with the actual IP and port of your Home Assistant instance.
        proxy_pass http://192.168.1.10:8123/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # WebSocket support for Home Assistant UI
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # --- Proxmox VE ---
    # Accessible at https://www.hogwarts-castle.com/proxmox/
    location /proxmox/ {
        # IMPORTANT: Replace with the actual IP and port of your Proxmox instance.
        proxy_pass https://192.168.1.11:8006/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # WebSocket support for Proxmox console
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        # Proxmox requires a specific rewrite
        rewrite /proxmox/(.*) /$1 break;
    }

    # --- OPNsense Firewall ---
    # Accessible at https://www.hogwarts-castle.com/opnsense/
    location /opnsense/ {
        # IMPORTANT: Replace with the actual IP and port of your OPNsense instance.
        proxy_pass https://192.168.1.1:443/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Nginx Proxy Manager (Example) ---
    # Accessible at https://www.hogwarts-castle.com/nginx/
    location /nginx/ {
        # IMPORTANT: Replace with the actual IP and port of your Nginx Proxy Manager.
        proxy_pass http://192.168.1.12:81/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # --- General Proxy Settings ---
    # These settings are good defaults for most reverse proxy setups.
    proxy_redirect off;
    proxy_buffering off;
}
